name: Despliegue a AWS

on:
  push:
    branches: [ "master" ]

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Desplegando en AWS
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USER }}
          key: ${{ secrets.EC2_SSH_KEY }}
          script: |
            # 1. Verificar si ya existe la carpeta, si no, clonar
            if [ ! -d "sitea_java" ]; then
              git clone https://github.com/siteaedu1/Sitea_Despliegue.git
            fi
            
            # 2. Entrar y actualizar c√≥digo
            cd sitea_java
            git pull origin main
            
            # 3. Reiniciar contenedores (Esto reconstruye con los cambios)
            # El --build asegura que se compile el nuevo WAR y se instale lo nuevo de Python
            sudo docker-compose up -d --build --remove-orphans
            
            # 4. Limpieza (Opcional)
            sudo docker image prune -f
